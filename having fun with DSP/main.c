#include "dsk6713_aic23.h"

Uint32 input_sample();
void output_sample(int out_data);
void comm_intr();

short TabModulation[192] =
{32767,32749,32697,32609,32487,32329,32137,31911,31650,31356,31028,30667,30273,29846,29388,28898,28377,
27826,27245,26635,25996,25329,24636,23915,23170,22399,21605,20787,19947,19086,18204,17303,16384,15446,
14492,13523,12539,11542,10533,9512,8481,7441,6393,5338,4277,3212,2143,1072,0,-1072,-2143,-3212,-4277,
-5338,-6393,-7441,-8481,-9512,-10533,-11542,-12539,-13523,-14492,-15446,-16384,-17303,-18204,-19086,
-19947,-20787,-21605,-22399,-23170,-23915,-24636,-25329,-25996,-26635,-27245,-27826,-28377,-28898,
-29388,-29846,-30273,-30667,-31028,-31356,-31650,-31911,-32137,-32329,-32487,-32609,-32697,-32749,
-32767,-32749,-32697,-32609,-32487,-32329,-32137,-31911,-31650,-31356,-31028,-30667,-30273,-29846,
-29388,-28898,-28377,-27826,-27245,-26635,-25996,-25329,-24636,-23915,-23170,-22399,-21605,-20787,
-19947,-19086,-18204,-17303,-16384,-15446,-14492,-13523,-12539,-11542,-10533,-9512,-8481,-7441,-6393,
5338,4277,3212,2143,1072,0,1072,2143,3212,4277,5338,6393,7441,8481,9512,10533,11542,12539,13523,14492,
15446,16384,17303,18204,19086,19947,20787,21605,22399,23170,23915,24636,25329,25996,26635,27245,27826,
28377,28898,29388,29846,30273,30667,31028,31356,31650,31911,32137,32329,32487,32609,32697,32749};


Uint32 fs = DSK6713_AIC23_FREQ_96KHZ;
Uint16 n = 0, PAS = 37, D = 4, k = 13;
short SignalPorteuse[192], SPn;
short SignalModulation[192];
short SignalDemodulation[192];
int  SMn = 0;
short Xn;

interrupt void c_int11()
{
	Xn = input_sample();
	SPn = TabModulation[(n*PAS)%192];
	SignalPorteuse[n] = SPn;



	//SMn = SPn + (short)((SPn * Xn) >> 15);
	 SMn = (int) (SPn * Xn);
	 SMn = (int) (SMn / D);
	 SMn = (int) (SMn >> k);
	 SMn = (int) SMn + (SPn);

	//SMn = SPn + (short)((SPn * Xn) / D) >> k;
	SignalModulation[n] = (short) (SMn >> 1);

	SignalDemodulation[n] = ((SignalPorteuse[n] * SignalModulation[n]) >> 15);
	output_sample(SignalDemodulation[n]);

	n = (n+1) % 192;
	return;
}

main()
{
	comm_intr();
	while(1);
}
